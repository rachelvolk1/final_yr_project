{% extends "base.html" %}

{% block title %}Preview{% endblock %}

{% block content %}
<!-- CSS Links -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/preview.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sb-admin-2.min.css') }}">

<div class="container-fluid">
    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">Preview</h1>

    <!-- Search -->
    <div class="mb-3">
        <input type="text" id="search-bar" class="form-control" placeholder="Search...">
    </div>

    <!-- Filter by Payment Date -->
    <div class="mb-3">
        <label for="filter-date">Filter by Payment Date:</label>
        <input type="date" id="filter-date" class="form-control">
    </div>

    <!-- Apply Filter Button -->
    <div class="mb-3">
        <button id="apply-filter" class="btn btn-primary">Apply Filter</button>
        <div id="status-message" class="status-message"></div>
    </div>

    <!-- DataTable -->
    <div class="card shadow mb-4 mt-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dataset Preview</h6>
        </div>
        <div class="card-body">
            <!-- Loading Spinner -->
            <div id="loading-spinner" style="display: none;" class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table" id="preview-table">
                    <thead id="table-header">
                        <!-- Dynamic headers will be inserted here -->
                    </thead>
                    <tbody id="table-body">
                        <!-- Data will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-controls">
        <button id="prev-page" class="btn btn-primary">Previous</button>
        <span id="page-number">1</span> / <span id="total-pages">1</span>
        <button id="next-page" class="btn btn-primary">Next</button>
    </div>
</div>

<!-- JavaScript code goes here -->
<script>
    $(document).ready(function() {
        let datasetId = "{{ instance_id }}";
        let fileName = "{{ filename }}";

        console.log("Dataset ID:", datasetId);
        console.log("File Name:", fileName);

        $.ajax({
            url: `/api/preview/${datasetId}/${fileName}`,  // Ensure this matches your Flask route
            method: 'GET',
            beforeSend: function() {
                $('#loading-spinner').show();  // Show spinner when loading starts
            },
            success: function(response) {
                displayPreviewData(response);
                $('#loading-spinner').hide();  // Hide spinner when loading is done
            },
            error: function(xhr, status, error) {
                $('#status-message').text('An error occurred while fetching the preview.');
                $('#loading-spinner').hide();  // Hide spinner on error
            }
        });

        function displayPreviewData(data) {
            const tableBody = $('#table-body');
            const tableHeader = $('#table-header');

            tableBody.empty();
            tableHeader.empty();

            if (data.error) {
                $('#status-message').text(data.error);
            } else if (data.length > 0) {
                const headers = Object.keys(data[0]);
                const headerRow = $('<tr></tr>');
                headers.forEach(function(header) {
                    headerRow.append(`<th>${header}</th>`);
                });
                tableHeader.append(headerRow);

                data.forEach(function(row) {
                    const rowData = $('<tr></tr>');
                    Object.values(row).forEach(function(value) {
                        rowData.append(`<td>${value}</td>`);
                    });
                    tableBody.append(rowData);
                });
            } else {
                tableBody.append('<tr><td colspan="9">No data available</td></tr>');
            }
        }
    });
</script>
{% endblock %}